/*
 * Parchment
 * Built: 2011-03-03
 *
 * Copyright (c) 2008-2010 The Parchment Contributors
 * Licenced under the GPL v2
 * http://code.google.com/p/parchment
 */
jQuery.ajaxSetup({cache:true,dataType:"text",ifModified:location.protocol!=="file:"});var parchment={options:{container:"#parchment",default_story:"stories/troll.z5.js",lib_path:"lib/",lock_story:0,page_title:1,proxy_url:"http://zcode.appspot.com/proxy/"},lib:{}};
/*
 * Simple JavaScript Inheritance
 * http://ejohn.org/blog/simple-javascript-inheritance/
 *
 * By John Resig
 * Released into the public domain?
 *
 * Inspired by base2 and Prototype
 */
(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,j){return function(){var l=this._super;this._super=f[h];var k=j.apply(this,arguments);this._super=l;return k}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.subClass=arguments.callee;return c}})();(function(){function b(h,j){return h[j]<<24|h[j+1]<<16|h[j+2]<<8|h[j+3]}function c(h){return[(h>>24)&255,(h>>16)&255,(h>>8)&255,h&255]}function e(j,k){var h=String.fromCharCode;return h(j[k])+h(j[k+1])+h(j[k+2])+h(j[k+3])}function g(h){return[h.charCodeAt(0),h.charCodeAt(1),h.charCodeAt(2),h.charCodeAt(3)]}var f=Object.subClass({init:function a(k){this.type="";this.chunks=[];if(k){if(e(k,0)!="FORM"){throw new Error("Not an IFF file")}this.type=e(k,8);var j=12,h=k.length;while(j<h){var m=b(k,j+4);if(m<0||(m+j)>h){throw new Error("IFF: Chunk out of range")}this.chunks.push({type:e(k,j),offset:j,data:k.slice(j+8,j+8+m)});j+=8+m;if(m%2){j++}}}},write:function d(){var m=g(this.type);for(var n=0,j=this.chunks.length;n<j;n++){var k=this.chunks[n],o=k.data,h=o.length;m=m.concat(g(k.type),c(h),o);if(h%2){m.push(0)}}return g("FORM").concat(c(m.length),m)}});f.num_from=b;f.num_to_word=c;f.text_from=e;f.text_to_word=g;window.IFF=f})();function Querystring(a){this.params={};this.get=Querystring_get;if(a==null){}a=location.search.substring(1,location.search.length);if(a.length==0){return}a=a.replace(/\+/g," ");var c=a.split("&");for(var d=0;d<c.length;d++){var f=c[d].split("=");var b=unescape(f[0]);var e=(f.length==2)?unescape(f[1]):b;this.params[b]=e}}function Querystring_get(a,b){var c=this.params[a];return(c!=null)?c:b}
/*
 * Taken from "Remedial Javascript" by Douglas Crockford:
 * http://javascript.crockford.com/remedial.html
 */
function typeOf(b){var a=typeof b;if(a==="object"){if(b){if(typeof b.length==="number"&&!(b.propertyIsEnumerable("length"))&&typeof b.splice==="function"){a="array"}}else{a="null"}}return a}function isEmpty(c){var b,a;if(typeOf(c)==="object"){for(b in c){a=c[b];if(a!==undefined&&typeOf(a)!=="function"){return false}}}return true}String.prototype.entityify=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};String.prototype.quote=function(){var e,b,a=this.length,d='"';for(b=0;b<a;b+=1){e=this.charAt(b);if(e>=" "){if(e==="\\"||e==='"'){d+="\\"}d+=e}else{switch(e){case"\b":d+="\\b";break;case"\f":d+="\\f";break;case"\n":d+="\\n";break;case"\r":d+="\\r";break;case"\t":d+="\\t";break;default:e=e.charCodeAt();d+="\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)}}}return d+'"'};String.prototype.supplant=function(a){return this.replace(/{([^{}]*)}/g,function(d,c){var e=a[c];return typeof e==="string"||typeof e==="number"?e:d})};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};(function(a){window.FatalError=function(b){this.message=b;this.traceback=this._makeTraceback(arguments.callee);this.onError(this);if(a(".load").length>0){a(".load").detach()}};FatalError.prototype={onError:function(c){var b=c.message;if(typeof c.message=="string"){b=b.entityify()}a("#content").append('<div class="error">An error occurred:<br/><pre>'+b+"\n\n"+c.traceback+"</pre></div>")},_makeTraceback:function(b){var f="";var d=0;var c=100;while(b!=null&&d<c){var g=b.toString();if(!g){f="\n  (anonymous function)"+f}else{var h=g.match(/function (\w*)/);if(!h||!h[1]){f="\n  (anonymous function)"+f}else{f="\n  "+h[1]+f}}try{b=b.caller}catch(j){b=null}d++}if(d==c){f="..."+f}return"Traceback (most recent call last):\n"+f}}})(jQuery);(function(j,g){function c(s,t){var t=t||[],r=0,q;for(q=s.length%8;r<q;++r){t.push(s.charCodeAt(r)&255)}for(q=s.length;r<q;){t.push(s.charCodeAt(r++)&255,s.charCodeAt(r++)&255,s.charCodeAt(r++)&255,s.charCodeAt(r++)&255,s.charCodeAt(r++)&255,s.charCodeAt(r++)&255,s.charCodeAt(r++)&255,s.charCodeAt(r++)&255)}return t}function n(u,t){var t=t||"",s=0,q,r=String.fromCharCode;for(q=u.length%8;s<q;++s){t+=r(u[s])}for(q=u.length;s<q;){t+=(r(u[s++])+r(u[s++])+r(u[s++])+r(u[s++])+r(u[s++])+r(u[s++])+r(u[s++])+r(u[s++]))}return t}if(j.atob){var e=function(r,q){return c(atob(r),q)},l=function(r,q){return btoa(n(r,q))}}else{var k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=(function(){var q=[],r=0;for(;r<k.length;r++){q[k.charAt(r)]=r}return q})(),e=function(v,t){var t=t||[],w,s,r,A,z,y,x,u=0,q=v.length;while(u<q){A=d[v.charAt(u++)];z=d[v.charAt(u++)];y=d[v.charAt(u++)];x=d[v.charAt(u++)];w=(A<<2)+(z>>4);s=((z&15)<<4)+(y>>2);r=((y&3)<<6)+x;t.push(w,s,r)}if(x==64){t.pop()}if(y==64){t.pop()}return t},l=function(v,t){var t=t||"",w,s,r,A,z,y,x,u=0,q=v.length;while(u<q){w=v[u++];s=v[u++];r=v[u++];A=w>>2;z=((w&3)<<4)+(s>>4);y=((s&15)<<2)+(r>>6);x=r&63;t+=(k.charAt(A)+k.charAt(z)+k.charAt(y)+k.charAt(x))}if(isNaN(s)){t=t.slice(0,-2)+"=="}else{if(isNaN(r)){t=t.slice(0,-1)+"="}}return t}}var p=jQuery.ajaxSettings.xhr(),m={binary:p.overrideMimeType!==undefined&&!(g.browser.opera&&parseFloat(g.browser.version)<10.5),cross_origin:p.withCredentials!==undefined};p=null;function h(x,y){var w=/^(file:|([\w-]+:)?\/\/[^\/?#]+)/,r;if(g.isArray(x)){r=x[1];x=x[0]}var H=w.exec(location)[0];var F=w.exec(x);var D=F?F[0]:H;var u;var I=null,v=null,q=null;var z=j.localStorage.getItem("games")||{};if(z[x]==undefined||z[x]["data"]==undefined||z[x]["data"]==""){xmlhttp=new XMLHttpRequest();xmlhttp.overrideMimeType("text/plain; charset=x-user-defined");var t=b(x);xmlhttp.open("GET",t,false);xmlhttp.send();var B=c(xmlhttp.responseText);if(/zblorb$/.test(x)){for(i=0;i<B.length-3;i++){if(String.fromCharCode(B[i])=="I"&&String.fromCharCode(B[i+1])=="F"&&String.fromCharCode(B[i+2])=="m"&&String.fromCharCode(B[i+3])=="d"){var E=B[i+4]*(Math.pow(2,24))+B[i+5]*(Math.pow(2,16))+B[i+6]*(Math.pow(2,8))+B[i+7];var C=B.slice(i+8,i+8+E);var s=new DOMParser();var A=s.parseFromString(n(C),"text/xml");var G=A.getElementsByTagName("bibliographic")[0];I=G.getElementsByTagName("title")[0].childNodes[0].nodeValue;v=G.getElementsByTagName("author")[0].childNodes[0].nodeValue;if(G.getElementsByTagName("genre").length>0){q=G.getElementsByTagName("genre")[0].childNodes[0].nodeValue}}}}b64_data=l(B);f({link:decodeURI(x),title:I,author:v,genre:q},b64_data,false);y(B)}else{z[x]["accessed"]=Math.round(new Date().getTime()/1000);j.localStorage.setItem("games",z);y(e(z[x]["data"]))}}function f(w,x,t,A){var t=t||false;var q=w.link;var v=j.localStorage.getItem("games")||{};if(!v[q]){v[q]={};v[q]["local"]=t;chrome.extension.sendRequest({url:q,author:w.author,title:w.title},function(C){})}var s=q.split("/").pop();var B=s.lastIndexOf(".");if(B==-1){B=s.length}s=s.substring(0,B);v[q]["title"]=w.title||s;v[q]["author"]=w.author||"";v[q]["genre"]=w.genre||"";v[q]["rating"]=w.rating||-1;v[q]["data"]=x;v[q]["accessed"]=Math.round(new Date().getTime()/1000);var r=false;while(!r){try{j.localStorage.setItem("games",v);r=true}catch(u){var y=Infinity;var z=null;for(key in v){if(v[key]["data"]!=undefined&&!v[key]["local"]){if(y>v[key]["accessed"]){y=v[key]["accessed"];z=key}}}if(z!=null){v[z]["data"]=undefined;try{j.localStorage.setItem("games",v);r=true}catch(u){}}else{v[q]["data"]=undefined;try{j.localStorage.setItem("games",v)}catch(u){}r=true}}}}function a(r,q,s){}function o(r){var t=/^(file:|([\w-]+:)?\/\/[^\/?#]+)/;var q=t.exec(r)?(t.exec(r)[0]+"/"):t.exec(location)[0];var s=["http://www.ifarchive.org/","http://ifarchive.org/","http://ifarchive.jmac.org/","http://ifmirror.russotto.net/","http://ifarchive.flavorplex.com/","http://ifarchive.smallwhitehouse.org/","http://ifarchive.wurb.com/","http://ifarchive.plover.net/","http://www.ifarchive.info/","http://ifarchive.ifreviews.org/","http://ifarchive.heanet.ie/","http://ifarchive.giga.or.at/"];if(g.inArray(q,s)>-1){r=r.replace(q,"http://mirror.ifarchive.org/")}return r}function b(s){var u=/^(file:|([\w-]+:)?\/\/[^\/?#]+)/;var r=u.exec(s)?(u.exec(s)[0]+"/"):u.exec(location)[0];if(r!="http://mirror.ifarchive.org/"){return s}var t=["http://www.ifarchive.org/","http://ifarchive.org/","http://ifarchive.jmac.org/","http://ifmirror.russotto.net/","http://ifarchive.flavorplex.com/","http://ifarchive.smallwhitehouse.org/","http://ifarchive.wurb.com/","http://ifarchive.plover.net/","http://www.ifarchive.info/","http://ifarchive.ifreviews.org/","http://ifarchive.heanet.ie/","http://ifarchive.giga.or.at/"];var q=t[Math.round(Math.random()*(t.length-1))];s=s.replace(r,q);return s}j.file={text_to_array:c,array_to_text:n,base64_decode:e,base64_encode:l,download_to_array:h,support:m,add_to_library:f,mirror_ifarchive_url:o}})(window,jQuery);(function(f){var e=this,g=f(document),a=/iPhone|iPod|iPad|Android/i,d=/\S/,c=e.scrollByPages||function(j){var h=g[0].documentElement.clientHeight,k=h-Math.min(h/10,parseInt(f("body").css("line-height"))*2);scrollBy(0,k*j)},b=e.getSelection||(document.selection&&function(){return document.selection.createRange().text})||function(){return""};e.gIsIphone=a.test(navigator.userAgent);if(f.browser.msie&&parseInt(f.browser.version)<7){f(function(){var j=f("#top-window"),h=function(){j.style.top=document.documentElement.scrollTop+"px"};j.css("position","absolute").resize(h).scroll(h)})}parchment.lib.UI=Object.subClass({stylesheet_add:function(){var h=arguments,j;for(j=1;j<h.length;j++){f("<link>",{rel:"alternate stylesheet",href:h[j],title:h[0]}).appendTo("head")[0].disabled=true}},stylesheet_switch:function(j,h){f("link[rel*=stylesheet][title="+j+"]").each(function(){this.disabled=!h})}});parchment.lib.TextInput=Object.subClass({init:function(h,m){var j=this,h=f(h),l=f("<input>",{autocapitalize:"off",keydown:function(o){var p=o.which,n;if(p==38){j.prev_next(1);n=1}if(p==40){j.prev_next(-1);n=1}if(p==33){c(-1);n=1}if(p==34){c(1);n=1}if(n){return false}}}),k=f("<input>",{"class":"CharInput",keydown:function(n){j.keyCode=n.which},keypress:function(n){j.charCode=n.which;j.submitChar();return false},keyup:function(n){j.submitChar()}});j.form=f("<form>",{"class":"LineInput",submit:function(){j.submitLine();return false}}).append(l);h.bind("click.TextInput",function(){if(b()==""){if(f(".LineInput").length){l.focus()}if(f(".CharInput").length){k.focus()}}});j.history=[];j.container=h;j.stream=f(m);j.lineInput=l;j.charInput=k},die:function(){this.container.unbind(".TextInput")},getLine:function(m,l){var k=this,h=k.stream.children().last(),j=k.lineInput;k.callback=m||f.noop;k.current=0;k.mutable_history=k.history.slice();k.mutable_history.unshift("");k.style=l||"";j.width(k.stream.width()-h.width()).val("").addClass(k.style);h.append(k.form);setTimeout(function(){j.focus()},1)},submitLine:function(){var h=this,j=h.lineInput.val();h.form.detach();h.lineInput.removeClass(h.style);f('<span class="finished-input">'+j.entityify()+"</span><br>").appendTo(h.stream.children().last());if(j!=h.history[0]&&d.test(j)){h.history.unshift(j)}g.trigger({type:"LineInput",input:j});h.callback(j)},prev_next:function(n){var j=this,h=j.lineInput,k=j.mutable_history,l=j.current,m=l+n;if(m<k.length&&m>=0){k[l]=h.val();h.val(k[m]);j.current=m}},getChar:function(k){var j=this,h=j.charInput;j.callback=k||f.noop;j.keyCode=j.charCode=0;j.container.append(h);setTimeout(function(){h.focus()},1)},submitChar:function(){var k=this,l=k.keyCode,h=k.charCode,j={keyCode:l,charCode:h};if(!l&&!h){return}k.charInput.detach();g.trigger({type:"CharInput",input:j});k.callback(j)}})})(jQuery);(function(e,f){var h=IFF.subClass({init:function a(p,k){this.title=k;if(p[0]<9){this.filetype="ok story naked zcode";this._super();this.chunks.push({type:"ZCOD",data:p});this.zcode=p}else{if(IFF.text_from(p,0)=="FORM"){this._super(p);if(this.type=="IFRS"){for(var n=0,j=this.chunks.length;n<j;n++){var o=this.chunks[n].type;if(o=="ZCOD"&&!this.zcode){this.zcode=this.chunks[n].data}else{if(o=="IFmd"){this.metadata=file.array_to_text(this.chunks[n].data);var m=f(this.metadata);if(m){if(f("title",m)){this.title=f("title",m).text()}if(f("ifid",m)){this.ifid=f("ifid",m).text()}if(f("release",m)){this.release=f("release",m).text()}}}}}if(this.zcode){this.filetype="ok story blorbed zcode"}else{this.filetype="error: no zcode in blorb"}}else{if(this.type=="IFZS"){this.filetype="error: trying to load a Quetzal savefile"}else{this.filetype="error unknown iff"}}}else{this.filetype="error unknown general"}}},load:function b(j){if(this.zcode){j.loadStory(this.zcode)}}}),d=Object.subClass({add:function(j){this[j.ifid]=j;if(j.url){this.url[j.url]=j}},url:{}}),c=function(l,k){var m,n=1,q,j=parchment.options.lib_path,p=function(r){if(f.isArray(r)){m=r}if(--n==0){q=setInterval(o,1)}},o=function(){if(k.loaded_zmachine||e.GnustoEngine&&e.Quetzal&&e.EngineRunner&&e.Console&&parchment.lib.ZUI&&m){k.loaded_zmachine=true;clearInterval(q);f("#progress-text").html("Starting interpreter...");var w=typeof console!==undefined?function(){}:function(x){e.console.log(x)},t=new GnustoEngine(w),s=new parchment.lib.ZUI(k,t,w),v=new EngineRunner(t,s,w),u=new h(m,storyName),r=location.hash;w("Story type: "+u.filetype);u.load(t);if(r&&r!="#"){t.loadSavedGame(file.base64_decode(r.slice(1)));w("Loading savefile")}v.run()}};if(!k.loaded_zmachine){n=3;f.getScript(j+"gnusto.min.js",p);f.getScript(j+"zmachine.min.js",p)}file.download_to_array(l,p)},g=Object.subClass({init:function(){var j=this;j.container=f(parchment.options.container);j.load_indicator=f('<div class="dialog load"><p>Parchment is loading.<p>&gt; <blink>_</blink></div>')},load:function(q){var k=this,m=parchment.options;f("body").append(k.load_indicator);if(m.lock_story){var o=m.default_story}else{var j=new Querystring(),o=j.get("story",m.default_story)}var l=f.isArray(o)?o[0]:o;k.url=l;storyName=l.slice(l.lastIndexOf("/")+1);storyName=storyName?storyName+" - Parchment":"Parchment";if(m.page_title){e.document.title=storyName}console.log(k.stories.url);if(k.stories.url[l]){var n=k.stories.url[l]}else{f("#progress-text").html("Retrieving story file...");try{c(o,k)}catch(p){throw new FatalError(p)}}},stories:new d(),savefiles:{}});parchment.lib.Library=g})(window,jQuery);(function(a,c){var d=a.parchment;function b(){if(a.parchment_options){c.extend(d.options,parchment_options)}c("#about").remove();var e=new d.lib.Library();d.library=e;e.load();if(location.href.slice(0,31)=="http://parchment.googlecode.com"){c.getScript("http://www.google-analytics.com/ga.js",function(){_gat._getTracker("UA-7949545-1")._trackPageview()})}}c(b)})(window,jQuery);